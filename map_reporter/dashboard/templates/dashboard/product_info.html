{% extends "dashboard_base.html" %}
{% load dashboard_tags %}
{% load static %}
{% load thumbnail %}
{% block title %}
    {{product.name}}
{% endblock %}

{% block headEnd %}
<link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
{% endblock headEnd %}

{% block main %}
{% comment %} <input type="text" id="demo" class="form-control"> {% endcomment %}
<h3 class="mt-4">Ανάλυση για το {{ product.name }}</h3>


{% comment %} <form id="date-picker-form" action="/update_dates/" method="post">
    {% csrf_token %}
    {{date_picker}}
    <button class="btn btn-primary" type="submit" value="Submit">Υποβολή</button>
    <div id="results"></div> <!-- errors go here -->
</form> {% endcomment %}

    <div class="row pt-lg-3">
        <div class="col-xl-4">
            <div class="card mb-4 h-100">
                <div class="card-header">
                    <i class="fas fa-chart-area me-1"></i>
                    Φωτογραφία
                </div>
                <div class="card-body align-items-center d-flex">
                    <img src="{{product.image.url}}" alt="product.name" width=100%>
                </div>
            </div>
        </div>

        <div class="col-xl-8">
            <div class="card mb-4 h-100">
                <div class="card-header">
                    <i class="fas fa-chart-area me-1"></i>
                    Χαρακτηριστικά
                </div>
                <div class="card-body align-items-center d-flex">
                    <div class="container">
                        <div class="row gx-5 bg-secondary bg-opacity-25">
                            <div class="col-4 g-0">
                                <h5 class="p-sm-2">Ενεργό</h5>
                            </div>
                            <div class="col-8 g-0">
                                <h5 class="p-sm-2">{{ product.is_active }}</h5>
                            </div>
                        </div>
                        <div class="row gx-5">
                            <div class="col-4 g-0">
                                <h5 class="p-sm-2">Κατασκευαστής</h5>
                            </div>
                            <div class="col-8 g-0">
                                <a class="link-dark fs-5" href="{% url 'manufacturer_info' product.manufacturer.id %}">{{product.manufacturer}}</a>
                            </div>
                        </div>
                        <div class="row gx-5 bg-secondary bg-opacity-25">
                            <div class="col-4 g-0">
                                <h5 class="p-sm-2">Μοντέλο</h5>
                            </div>
                            <div class="col-8 g-0">
                                <h5 class="p-sm-2">{{ product.model }}</h5>
                            </div>
                        </div>
                        <div class="row gx-5">
                            <div class="col-4 g-0">
                                <h5 class="p-sm-2">SKU</h5>
                            </div>
                            <div class="col-8 g-0">
                                <h5 class="p-sm-2">{{ product.sku }}</h5>
                            </div>
                        </div>
                        <div class="row gx-5 bg-secondary bg-opacity-25">
                            <div class="col-4 g-0">
                                <h5 class="p-sm-2">Τιμή MAP</h5>
                            </div>
                            <div class="col-8 g-0">
                                <h5 class="p-sm-2">{{ product.map_price }}</h5>
                            </div>
                        </div>
                        <div class="row gx-5">
                            <div class="col-4 g-0">
                                <h5 class="p-sm-2">Κατηγορία</h5>
                            </div>
                            <div class="col-8 g-0">
                                <p class="p-sm-2">
                                    {% for category in product.main_category.get_family %}
                                        <a class="link-dark fs-5" href="{% url 'category_info' category.id %}">{{category}}</a>
                                        {% if not forloop.last %}
                                            >
                                        {% endif %}
                                    {% endfor %}
                                </p>
                            </div>
                        </div>
                        <div class="row gx-5 bg-secondary bg-opacity-25">
                            <div class="col-4 g-0">
                                <h5 class="p-sm-2">Σελίδες</h5>
                            </div>
                            <div class="col-8 g-0">
                                <div class="row g-0">
                                    {% for url in urls %}
                                        <a href="{{ url }}" target="_blank" rel="noopener noreferrer" class="text-truncate mt-2 link-dark">{{ url }}</a>
                                    {% endfor %}
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            </div>
        </div>
    
        <div class="container-fluid mt-5">
            <div class="row">
                <form name="date_range" id="date-picker-form" hx-post="/update_date/{{product.id}}" hx-trigger="submit" hx-swap="none" hx-target-error="error_notice">
                    <div class="row">

                        <div class="col-lg-3">
                            {{date_picker}}
                    {% comment %} <form name="date_range" id="date-picker-form" hx-post="/update_date/" trigger="submit" hx-target="#results"> {% endcomment %}
                        </div>
                        <div class="col-lg-9">

                            <div class="dropdown mt-4">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="ShopSelectDropdown" data-bs-toggle="dropdown" aria-expanded="false">
                                  Επιλέξτε Καταστήματα
                                </button>

                                <ul class="dropdown-menu overflow-auto p-0" style="max-height:300px;" aria-labelledby="ShopSelectDropdown">

                                    <div class="search sticky-top p-1 w-100 bg-white">
                                        <input type="text" class="form-control" placeholder="Αναζήτηση" id="shop_search">
                                    </div>
                                    <li class="p-2">
                                        <div class="form-check">
                                            <label class="form-check-label">
                                                <input class="select-all" name="select_all" type="checkbox" value="Επιλογή Όλων" id="ShopSelectAllCheckbox">
                                                Επιλογή Όλων
                                            </label>
                                        </div>
                                    </li>
                                    {% for shop in shops %}
                                    <li class="p-2">
                                        <div class="form-check">
                                            <label class="form-check-label">
                                                <input class="form-check-input" name="{{shop}}" type="checkbox" value="{{shop.id}}" id="ShopSelectCheckbox{{ forloop.counter0 }}">
                                                {{shop}}
                                            </label>
                                        </div>
                                    </li>
                                    {% endfor %}

                                </ul>

                            </div>
                        </div>

                    </div>
                        <button class="btn btn-primary mt-2" type="submit" value="Submit">Υποβολή</button>
                        <div style="display:none;" class="mt-2 text-danger" id="error_notice"></div> <!-- errors go here -->
                    </form>
            </div>
        </div>
    <div class="row pt-lg-5">
        <div class="col-xl-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-chart-area me-1"></i>
                    Ελάχιστες τιμές προϊόντος
                </div>
                <div class="card-body align-items-center d-flex" style="height:500px;"><canvas id="MinPriceChart" width="100%" height="40"></canvas></div>
                <div class="card-footer small text-muted">Τελευταία ενημέρωση {{ latest_timestamp }}</div>
            </div>
        </div>

        <div class="col-xl-6">
            <div class="card h-100">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    Ανάλυση τιμών καταστημάτων
                </div>
                <div class="card-body align-items-center d-flex" style="height:500px;"><canvas id="myPieChart" width="100%" height="50"></canvas></div>
                <div class="card-footer small text-muted">Τελευταία ενημέρωση {{ latest_timestamp }}</div>
            </div>
        </div>
        
        <div class="card mb-4 mt-4">
        <div class="card-header">
            <i class="fas fa-table me-1"></i>
            Πίνακας τιμών προϊόντος
        </div>
        <div class="card-body">
            <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="print-selector" data-bs-toggle="dropdown" aria-expanded="false">
                    Τύπος Εξαγωγής
                </button>
                <ul class="dropdown-menu" aria-labelledby="print-selector" id="product_prices_table-dropdown">
                    <li><a class="dropdown-item" area-value="" href="#">Εξαγωγή σελίδας</a></li>
                    <li><a class="dropdown-item" area-value="all" href="#">Εξαγωγή όλων</a></li>
                    <li><a class="dropdown-item" area-value="selected" href="#">Εξαγωγή επιλεγμένων</a></li>
                </ul>
            </div>
            <table id="product_prices_table"
                    data-toggle="table"
                    data-show-columns="true"
                    data-show-columns-toggle-all="true"
                    data-pagination="true"
                    data-show-toggle="true"
                    data-show-fullscreen="true"
                    data-buttons="buttons" 
                    data-buttons-align="left"
                    data-buttons-class="primary"
                    data-pagination-v-align="both"
                    data-remember-order="true"
                    data-sort-reset="true"
                    data-filter-control="true"
                    data-show-search-clear-button="true"
                    data-show-export="true"
                    data-show-print="true"
                    data-sticky-header="true"
                    data-show-multi-sort="true"
                    data-sort-priority='[{"sortName": "date","sortOrder":"desc"},{"sortName":"retail_price","sortOrder":"asc"}]'
                    >
                <thead>
                    <tr>
                        <th data-sortable="true" data-field="shop_t" data-filter-control="input">Κατάστημα</th>
                        <th data-sortable="true" data-field="retail_price_t">Λ. Τιμή</th>
                        <th data-sortable="true" data-field="target_price_t">Target Price</th>
                        <th data-sortable="true" data-field="diff_t">Diff</th>
                        <th data-sortable="true" data-field="per_diff_t">Diff %</th>
                        <th data-sortable="true" data-field="official_reseller_t" data-filter-control="select">Επ. Μεταπωλητής</th>
                        {% if not seller_flag %}
                            <th data-sortable="true" data-field="seller_t" data-filter-control="select">Πωλητής</th>
                        {% endif %}
                        <th data-sortable="true" data-field="date_t">Ημερομηνία</th>
                    </tr>
                </thead>
                <tbody>
                    {% for retailprice in retailprices %}
                    {% if retailprice.price|sub:retailprice.curr_target_price < 0 %}
                        <tr class="bg-danger" style="--bs-bg-opacity: .1;">
                    {% else %}
                        <tr>
                    {% endif %}
                        <td><a href="{% url 'shop_info' retailprice.shop.id %}" class="link-dark">{{retailprice.shop}}</a></td>
                        <td>
                            {{retailprice.price}} €
                        </td>
                        <td>
                            {{retailprice.curr_target_price}} €
                        </td>
                        <td>
                            {% if retailprice.price|sub:retailprice.curr_target_price < 0 %}
                                <p class="text-danger">{{retailprice.price|sub:retailprice.curr_target_price}} €</p>
                            {% elif retailprice.price|sub:retailprice.curr_target_price > 0 %}
                                <p class="text-success">{{retailprice.price|sub:retailprice.curr_target_price}} €</p>
                            {% else %}
                                <p class="text-black">{{retailprice.price|sub:retailprice.curr_target_price}} €</p>
                            {% endif %}
                        </td>
                        <td>
                            {% if retailprice.price|ch_sub:retailprice.curr_target_price < 0 %}
                                <p class="text-danger">{{retailprice.price|ch_sub:retailprice.curr_target_price}} %</p>
                            {% elif retailprice.price|sub:retailprice.curr_target_price > 0 %}
                                <p class="text-success">{{retailprice.price|ch_sub:retailprice.curr_target_price}} %</p>
                            {% else %}
                                <p class="text-black">{{retailprice.price|ch_sub:retailprice.curr_target_price}} %</p>
                            {% endif %}
                        </td>
                        <td>
                            {{ retailprice.is_shop_official_reseller }}
                        </td>
                        {% if not seller_flag %}
                            <td>{{ retailprice.shop.seller.last_name }}</td>
                        {% endif %}
                        <td>{{retailprice.timestamp}}</td>
                    </tr>
                    {% endfor %}
                    
                </tbody>
            </table>
        </div>
    </div>
</div>
{{common_dates}}
<script>
    // Area Chart
    var ctx = document.getElementById("MinPriceChart");
    var myLineChart = new Chart(ctx, {
    type: 'line',
    data: {
        labels: [
            {% for min_retailprice in min_retailprice_list %}
                '{{min_retailprice.timestamp}}',
            {% endfor %}
        ],
        datasets: [{
            label: "Τιμή",
            lineTension: 0.3,
            backgroundColor: "rgba(2,117,216,0.2)",
            borderColor: "rgba(2,117,216,1)",
            pointRadius: 5,
            pointBackgroundColor: "rgba(2,117,216,1)",
            pointBorderColor: "rgba(255,255,255,0.8)",
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "rgba(2,117,216,1)",
            pointHitRadius: 50,
            pointBorderWidth: 2,
            data: [
                {% for min_retailprice in min_retailprice_list %}
                    '{{min_retailprice.min_price}}',
                {% endfor %}
            ],
        },
        {
            label: "Target Price",
            lineTension: 0.3,
            backgroundColor: "rgba(220,53,69,0.2)",
            borderColor: "rgba(220,53,69,1)",
            pointRadius: 5,
            pointBackgroundColor: "rgba(220,53,69,1)",
            pointBorderColor: "rgba(255,255,255,0.8)",
            pointHoverRadius: 5,
            pointHoverBackgroundColor: "rgba(220,53,69,1)",
            pointHitRadius: 50,
            pointBorderWidth: 2,
            data: [
                {% for min_retailprice in min_retailprice_list %}
                    '{{min_retailprice.curr_target_price}}',
                {% endfor %}
            ],
        }],
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
        scales: {
        xAxes: {
            time: {
            unit: 'date'
            },
            gridLines: {
            display: false
            },
            ticks: {
            maxTicksLimit: 10
            }
        },
        yAxes: {
            ticks: {
            min: {{min_retailprice.min_price__min|per_sub:"10"}},
            max: {{max_retailprice.min_price__max|per_add:"10"}},
            maxTicksLimit: 5
            },
            gridLines: {
            color: "rgba(0, 0, 0, .125)",
            }
        },
        },
        legend: {
        display: false
        }
    }
    });


     // We create a random rgb colour ATTENTION!! a value is missing!!!
     var dynamicColors = function() {
        var r = Math.floor(Math.random() * 255);
        var g = Math.floor(Math.random() * 255);
        var b = Math.floor(Math.random() * 255);
        if (r < 240 && g < 240 && b < 240 || (r == 220 && b == 53 && g == 69)){
            dynamicColors();
        }
        return "rgb(" + r + "," + g + "," + b ;
     };
        
    // Pie Chart Example
    var ctx = document.getElementById("myPieChart");
    var myPieChart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ["Κάτω", "Ακριβώς", "Πάνω"],
        datasets: [{
        data: [{{shops_below}}, {{shops_equal}}, {{shops_above}}],
        backgroundColor: ['#dc3545', '#28a745', '#007bff'],
        }],
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
    }
    });

    //top table
    var $all_products_table = $('#product_prices_table');

    $(function() {
        $('#product_prices_table-dropdown').find('.dropdown-item').on('click', function (e) {
            e.preventDefault();
            selector_btn = document.getElementById('print-selector');
            selector_btn.innerText = e.target.innerText; 
            data = {};
            if (e.target.attributes['area-value'].value == 'selected'){
                data = {
                    field: 'state',
                    checkbox: true,
                    visible: $(this).attr('area-value') === 'selected'
                };
            }
            $all_products_table.bootstrapTable('destroy').bootstrapTable({
                exportDataType: $(this).attr('area-value'),
                exportTypes: ['csv', 'txt', 'excel', 'pdf'],
                columns: [
                    data,
                ]
            })
            }).trigger('change')
    });

   /* $(document).ready(function(){
        the_table = $('#product_prices_table').bootstrapTable({
            sortPriority:[
                    {
                        "sortName": "date",
                        "sortOrder":"desc"
                    },
                    {
                        "sortName":"retail_price",
                        "sortOrder":"asc"
                    },
                ]
        });
    });*/

    $(window).on('load', ()=>{
        export_btn_group = $('.export.btn-group');
        exoport_dropdown = export_btn_group.find("[aria-label='Export']");
        exoport_dropdown.parent().css("cursor", "not-allowed");
        exoport_dropdown.each( (index, elements) => {
            $(elements).attr("disabled", "true");
        });
    });
        
        //stop dropdown from closing on click, so we can select multiple shops
        $('body').on('click', function(e){
        dropdown_elem = $('#ShopSelectDropdown');
        target_element = $(e.target);
        if (target_element.hasClass('form-check-label') || target_element.hasClass('form-check')){
            e.stopPropagation();
        }
        if (target_element.attr('id') == 'ShopSelectAllCheckbox'){
            checkboxes = $('.form-check-input');
            if (target_element.prop('checked') == true ){
                checkboxes.each(function(i, element){
                    $(this).prop('checked', true);
                });
            } 
            else if (target_element.prop('checked') == false ){
                checkboxes.each(function(i, element){
                    $(this).prop('checked', false);
                });
            } 
    }
    });

    //function to enable search on the shops dropdown
    $(document).ready(function(){
        $("#shop_search").on("keyup", function() {
            var value = $(this).val().toLowerCase();
            $(".dropdown-menu li").filter(function() {
            $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1)
            });
        });
        });

    // What should i do with the response from the server?
    document.body.addEventListener('htmx:afterRequest', function (evt) {
        const targetError = evt.target.attributes.getNamedItem('hx-target-error')
        if (evt.detail.failed && targetError) {
            // We got an error
            error_elem = document.getElementById(targetError.value);
            error_elem.innerHTML = "Δεν υπάρχουν τιμές για αυτό το διάστημα και καταστήματα που ζητάτε."
            error_elem.style.display = "block";
        } else {
            // Update the charts
            const my_response_text = evt.detail.xhr.response;
            my_response = JSON.parse(my_response_text);
            console.log(my_response.table)

            new_pie_data = [my_response.shops_below, my_response.shops_equal, my_response.shops_above];
            myPieChart.data.datasets[0].data = new_pie_data;
            myPieChart.update();

            bubble_charts = [];
            for(i=0; i < my_response.shops_list.length; i++){
                this_shop = my_response.shops_list[i];
                bubble_charts.push(
                    {
                        type: 'bubble',
                        label: this_shop.name,
                        data: this_shop.prices,
                        backgroundColor: dynamicColors() + ", 1)"
                    }
                );
            }

            new_mixed_data = {
                labels: my_response.timestamp_list,
                datasets: [{
                    type: 'line',
                    label: "Target Price",
                    lineTension: 0.3,
                    backgroundColor: "rgba(220,53,69,0.2)",
                    borderColor: "rgba(220,53,69,1)",
                    pointRadius: 5,
                    pointBackgroundColor: "rgba(220,53,69,1)",
                    pointBorderColor: "rgba(255,255,255,0.8)",
                    pointHoverRadius: 5,
                    pointHoverBackgroundColor: "rgba(220,53,69,1)",
                    pointHitRadius: 50,
                    pointBorderWidth: 2,
                    data: my_response.target_prices,
                },
                    ...bubble_charts,
                ],
            };
            myLineChart.data = new_mixed_data;
            myLineChart.update();
            table = $('#product_prices_table');
            table.bootstrapTable('destroy');
            table.html(my_response.table);
            table.bootstrapTable();
            
        }
    });

    document.body.addEventListener('htmx:beforeRequest', function (evt) {
        const targetError = evt.target.attributes.getNamedItem('hx-target-error')
        if (targetError) {
          document.getElementById(targetError.value).style.display = "none";
        }
      });

    // Get all checked items from the dropdown and add them in the request parameters
    document.body.addEventListener('htmx:configRequest', function(evt) {
    if (evt.target.id == 'date-picker-form'){
        checkboxes = $('.form-check-input');
        shop_list = '';
        checkboxes.each(
            function(i,elem) {
                if($(this).prop('checked') == true){
                    shop_list += $(this).val() + ' ';
                }
            }
            );
            if(shop_list == ''){
                error_elem = document.getElementById('error_notice')
                error_elem.innerHTML = 'Παρακαλώ επιλέξτε τουλάχιστον ένα κατάστημα.'
                error_elem.style.display = "block";
                evt.preventDefault();
            } else {
                error_elem = document.getElementById('error_notice')
                error_elem.innerHTML = ''
                error_elem.style.display = "none";
            }
        }
        evt.detail.parameters['shops_list'] = shop_list; // add a new parameter into the mix
    });

//function to make the table pre-sorted
    {% comment %} $(document).ready(function(){
        the_table = $('#product_prices_table').bootstrapTable({
            showMultiSort:true,
            sortPriority:[
                {
                    "sortName": "date","sortOrder":"desc"
                },
                {
                    "sortName":"target_price","sortOrder":"asc"
                }
                ]
        });
    }); {% endcomment %}
    /*$(function() {
        $('#product_prices_table').bootstrapTable()
      });*/
</script>

{% endblock main %}