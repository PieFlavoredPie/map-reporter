{% extends 'dashboard_base.html' %}
{% load dashboard_tags %}
{% load static %}
{% load thumbnail %}
{% block title %}
Dashboard
{% endblock %}

{% block headEnd %}


{% endblock %}
{% block main %}
<div class="container-fluid px-4">
    <h1 class="mt-4">Dashboard</h1>
    <ol class="breadcrumb mb-4">
        <li class="breadcrumb-item active">Dashboard</li>
    </ol>
    <div class="row">
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body"><b>Προϊόντα</b></div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{%url 'all_products'%}">Μετάβαση</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body"><b>Κατηγορίες</b></div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{%url 'categories_page'%}">Μετάβαση</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body"><b>Καταστήματα</b></div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{%url 'shops_page'%}">Μετάβαση</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card bg-primary text-white mb-4">
                <div class="card-body"><b>Κατασκευαστές</b></div>
                <div class="card-footer d-flex align-items-center justify-content-between">
                    <a class="small text-white stretched-link" href="{%url 'manufacturer_page'%}">Μετάβαση</a>
                    <div class="small text-white"><i class="fas fa-angle-right"></i></div>
                </div>
            </div>
        </div>
    </div>
    <div class="row">
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    Ανάλυση τιμών προϊόντων
                </div>
                <div class="card-body align-items-center d-flex" d-flex style="height:500px;"><canvas id="PieChartProducts" width="100%" height="50"></canvas></div>
                <div class='card-footer small text-muted'>Πόσες τιμές από όλα τα ενεργά προϊόντα από όλα τα καταστήματα, την τελευταία φορά που τα βρήκαμε είναι κάτω, πάνω ή ίση από την τιμή στόχου</div>
                <div class='card-footer small text-muted'>Τελευταία ενημέρωση {{ latest_timestamp }}</div>
            </div>
        </div>
        <div class="col-xl-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    Ανάλυση καταστημάτων
                </div>
                <div class="card-body align-items-center d-flex" d-flex style="height:500px;"><canvas id="PieChartShops" width="100%" height="50"></canvas></div>
                <div class='card-footer small text-muted'>Πόσα καταστήματα έχουν τουλάχιστον ένα ενεργό προϊόν κάτω από την τιμή στόχου και πόσα δεν έχουν κανένα</div>
                <div class='card-footer small text-muted'>Τελευταία ενημέρωση {{ latest_timestamp }}</div>
            </div>
        </div>
    </div>
    <div class="row pt-lg-5">
        <div class='card mb-4'>
            <div class='card-header mb-4'>
                <i class='fas fa-table me-1'></i>
                Τελευταίες τιμές όλων των ενεργών προϊόντων με πρόβλημα
            </div>
            <div class="card-body">
              <div class="dropdown">
                <button class="btn btn-primary dropdown-toggle" type="button" id="bottom-print-selector" data-bs-toggle="dropdown" aria-expanded="false" >Τυπος Εξαγωγής</button>
                <ul class="dropdown-menu" aria-labelledby="bottom-print-selector" id="only-below-prices-table_print-dropdown">
                  <li><a class="dropdown-item" area-value="" href="#">Εξαγωγή σελίδας</a></li>
                  <li><a class="dropdown-item" area-value="all" href="#">Εξαγωγή όλων</a></li>
                  <li><a class="dropdown-item" area-value="selected" href="#">Εξαγωγή επιλεγμένων</a></li>
                </ul>
              </div>

                <table id='only-below-prices-table'
                    data-toggle="table"
                    data-show-columns="true"
                    data-show-columns-toggle-all="true"
                    data-pagination="true"
                    data-show-toggle="true"
                    data-show-fullscreen="true"
                    data-buttons="buttons"
                    data-buttons-align="left"
                    data-buttons-class="primary"
                    data-pagination-v-align="both"
                    data-remember-order="true"
                    data-sort-reset="true"
                    data-filter-control="true"
                    data-sort-select-options="true"
                    data-show-search-clear-button="true"
                    data-show-export="true"
                    data-show-print="true"
                    data-sticky-header="true"
                    data-show-multi-sort="true"
                    {% comment %} We need to sort the table like below, but it does not work. No idea why.
                    data-sort-priority='[{"sortName": "model","sortOrder":"desc"},{"sortName": "date","sortOrder":"desc"},{"sortName":"retail_price","sortOrder":"asc"}]' {% endcomment %}
                    >
                    <!--data-search-highlight use for highlight individual column search-->
                    <thead>
                        <tr class="bg-light">
                            <th data-sortable="true" data-field="product_image_b">Φωτογραφία</th>
                            <th data-sortable="true" data-field="manufacturer_b" data-filter-control="select">Κατασκευαστής</th>
                            <th data-sortable="true" data-field="model_b" data-filter-control="input">Μοντέλο</th>
                            <th data-sortable="true" data-field="sku_b" data-filter-control="input">SKU</th>
                            <th data-sortable="true" data-field="shop_b" data-filter-control="input">Κατάστημα</th>
                            <th data-sortable="true" data-field="retail_price_b">Τιμή</th>
                            <th data-sortable="true" data-field="target_price_b">MAP</th>
                            <th data-sortable="true" data-field="diff_b">Diff</th>
                            <th data-sortable="true" data-field="per_diff_b">Diff %</th>
                            <th data-sortable="true" data-field="official_reseller_b" data-filter-control="select">Επ. Μεταπωλητής</th>
                            {% if not seller_flag %}
                            <th data-sortable="true" data-field="seller" data-filter-control="select">Πωλητής</th>
                            {% endif %}
                            <th data-sortable="true" data-field="date">Ημερομηνία</th>
                            {% comment %} We can use this: data-filter-control="datepicker" to show a datepicker filter at the column headers {% endcomment %}
                        </tr>
                    </thead>
                    <tbody>
                    {% for retail_price in retail_prices %}
                        {% if retail_price.product.active %}
                        {% if retail_price.price|sub:retail_price.curr_target_price < 0 %}
                            <tr class="bg-danger" style="--bs-bg-opacity: .1;">
                                <td>
                                    <a href="{% url 'product_info' retail_price.product.id %}">
                                    {% thumbnail retail_price.product.image table_image_size as im %}
                                        <img src="{{ im.url }}" aria-src="{{ im.url|datalize }}" width="{{ im.width }}" height="{{ im.height }}" alt="{{retail_price.product.name}}" class="prod-img">
                                    {% endthumbnail %}
                                    </a>
                                    
                                </td>
                                <td>
                                    <a href="{% url 'manufacturer_info' retail_price.product.manufacturer.id %}" class="link-dark">
                                        {{retail_price.product.manufacturer}}
                                    </a>
                                </td>
                                <td>
                                    <a href="{% url 'product_info' retail_price.product.id %}" class="link-dark">
                                        {{retail_price.product.model}}
                                    </a>
                                </td>
                                <td>
                                    {{retail_price.product.sku}}
                                </td>
                                <td>
                                    <a href="{% url 'shop_info' retail_price.shop.id %}" class="link-dark">{{retail_price.shop}}</a>
                                </td>
                                <td>
                                    {{retail_price.price}} €
                                </td>
                                <td>
                                    {{retail_price.curr_target_price}} €
                                </td>
                                <td>
                                    {% if retail_price.price|sub:retail_price.curr_target_price < 0 %}
                                        <p class='text-danger'>{{retail_price.price|sub:retail_price.curr_target_price}} €</p>
                                    {% elif retail_price.price|sub:retail_price.curr_target_price > 0 %}
                                        <p class='text-success'>{{retail_price.price|sub:retail_price.curr_target_price}} €</p>
                                    {% else %}
                                        <p class='text-black'>{{retail_price.price|sub:retail_price.curr_target_price}} €</p>
                                    {% endif %}
                                </td>
                                <td>
                                    {% if retail_price.price|ch_sub:retail_price.curr_target_price < 0 %}
                                        <p class='text-danger'>{{retail_price.price|ch_sub:retail_price.curr_target_price}} %</p>
                                    {% elif retail_price.price|sub:retail_price.curr_target_price > 0 %}
                                        <p class='text-success'>{{retail_price.price|ch_sub:retail_price.curr_target_price}} %</p>
                                    {% else %}
                                        <p class='text-black'>{{retail_price.price|ch_sub:retail_price.curr_target_price}} %</p>
                                    {% endif %}
                                </td>
                                <td>
                                    {{ retail_price.is_shop_official_reseller }}
                                </td>
                                {% if not seller_flag %}
                                <td>{{ retail_price.shop.seller.last_name }}</td>
                                {% endif %}
                                <td>{{retail_price.timestamp}}</td>
                            </tr>
                        {% endif %}
                        {% endif %}
                    {% endfor %}
                    </tbody>
                </table>
        </div>
    </div>
    </div>
</div>
<script>
    // Pie Chart for products
    var ctx = document.getElementById('PieChartProducts');
    var myPieChart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ['Κάτω', 'Ακριβώς', 'Πάνω'],
        datasets: [{
        data: [{{products_below}}, {{products_equal}}, {{products_above}}],
        backgroundColor: ['#dc3545', '#28a745', '#007bff'],
        }],
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
    }
    });
    
    // Pie Chart for shops
    var ctx = document.getElementById('PieChartShops');
    var myPieChart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ['Κάτω', 'OK'],
        datasets: [{
        data: [{{shops_below}}, {{shops_ok}}],
        backgroundColor: ['#dc3545', '#007bff'],
        }],
    },
    options: {
        responsive: true,
        maintainAspectRatio: false,
    }
    });

    // bottom Table export
    var $all_products_prices_table = $('#only-below-prices-table');

    $(function() {
        $('#only-below-prices-table_print-dropdown').find('.dropdown-item').on('click', function (e) {
            e.preventDefault();
            selector_btn = document.getElementById('bottom-print-selector');
            selector_btn.innerText = e.target.innerText; 
            data = {};
            if (e.target.attributes['area-value'].value == 'selected'){
                data = {
                    field: 'state',
                    checkbox: true,
                    visible: $(this).attr('area-value') === 'selected'
                };
            }
            $all_products_prices_table.bootstrapTable('destroy').bootstrapTable({
                exportDataType: $(this).attr('area-value'),
                exportTypes: ['csv', 'txt', 'excel', 'pdf'],
                columns: [
                    data,
                ]
            })
            }).trigger('change')
    });


  
    $(window).on('load', ()=>{
        export_btn_group = $('.export.btn-group');
        exoport_dropdown = export_btn_group.find("[aria-label='Export']");
        exoport_dropdown.parent().css("cursor", "not-allowed");
        exoport_dropdown.each( (index, elements) => {
            $(elements).attr("disabled", "true");
        });
    });
    
</script>
{% endblock %}