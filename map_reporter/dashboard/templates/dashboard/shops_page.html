{% extends "dashboard_base.html" %}

{% load static %}

{% block title %}
Καταστήματα
{% endblock %}

{% block headEnd %}
{% endblock %}

{% block main %}

<h1 class="mb-4">Καταστήματα</h1>
<div class="container-fluid">
    <div class="row">
        <div class="col col-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="fas fa-chart-pie me-1"></i>
                    % Καταστημάτων που είναι οκ στην τιμή
                </div>
                <div class="card-body">
                    <canvas id="myPieChart" width="100%" height="50"></canvas>
                </div>
                <div class='card-footer small text-muted'>Τελευταία ενημέρωση {{ latest_timestamp }}</div>
            </div>
        </div>
        <div class="col col-6">
            <h5 class="mb-4">
               Lorem, ipsum dolor sit amet consectetur adipisicing elit. Dolor vitae adipisci unde explicabo eaque porro aspernatur, nisi sapiente est nesciunt iste cum! Iste iusto autem quo doloribus suscipit laudantium quam!
            </h5>
        </div> 
    </div>    
</div>    
    <div class="container-fluid mb-5">
        <div class="row">
            <div class="col">
                <div class="card mb-4">
                    <div class="card-header mb-4">
                        <i class="fas fa-table me-1"></i>
                        Καταστήματα
                    </div>
                        <div class="card-body">
                            <div class="dropdown">
                                <button class="btn btn-primary dropdown-toggle" type="button" id="print-selector" data-bs-toggle="dropdown" aria-expanded="false">
                                  Τύπος Εξαγωγής
                                </button>
                                <ul class="dropdown-menu" aria-labelledby="print-selector" id="shops-table_print-dropdown">
                                  <li><a class="dropdown-item" area-value="" href="#">Εξαγωγή σελίδας</a></li>
                                  <li><a class="dropdown-item" area-value="all" href="#">Εξαγωγή όλων</a></li>
                                  <li><a class="dropdown-item" area-value="selected" href="#">Εξαγωγή επιλεγμένων</a></li>
                                </ul>
                              </div>
                            <table id='shops-table' 
                            data-toggle="table" 
                            data-show-columns="true" 
                            data-show-columns-toggle-all="true" 
                            data-pagination="true" 
                            data-show-toggle="true" 
                            data-show-fullscreen="true" 
                            data-buttons="buttons" 
                            data-buttons-align="left" 
                            data-buttons-class="primary" 
                            data-pagination-v-align="both" 
                            data-remember-order="true" 
                            data-sort-reset="true" 
                            data-filter-control="true" 
                            data-show-search-clear-button="true" 
                            data-show-multi-sort="true" 
                            data-show-export="true" 
                            data-show-print="true" 
                            data-sticky-header="true">
                                <thead>
                                <tr class="bg-light">
                                    <th data-field="shop_name" data-filter-control="input" data-sortable="true">Όνομα καταστήματος</th>
                                    {% if not seller_flag %}
                                    <th data-field="seller" data-filter-control="select" data-sortable="true">Πωλητής</th>
                                    {% endif %}
                                    <th data-field="prod_count" data-sortable="true"># Προϊόντων</th>
                                    <th data-field="prods_below" data-sortable="true"># Προϊόντων κάτω</th>
                                    <th data-field="prods_equal" data-sortable="true"># Προϊόντων ίσα</th>
                                    <th data-field="prods_above" data-sortable="true"># Προϊόντων πάνω</th>
                                </tr>
                                </thead>
                                <tbody>
                                    {% for shop in shops %}
                                    <tr>
                                        <td>
                                            <a href="{% url 'shop_info' shop.id %}" class="link-dark">
                                                {{shop.name}}
                                            </a>
                                        </td>
                                        {% if not seller_flag %}
                                        <td>
                                            {{shop.seller.last_name}}
                                        </td>
                                        {% endif %}
                                        <td>
                                            {{shop.prod_count}}
                                        </td>
                                        <td class="text-danger">
                                            {{shop.this_shop_below}}
                                        </td>
                                        <td class="text-primary">
                                            {{shop.this_shop_equal}}
                                        </td>
                                        <td class="text-success">
                                            {{shop.this_shop_above}}
                                        </td>
                                    </tr>
                                    {% endfor %}
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
  <script>
    {% comment %} Chart.defaults.global.defaultFontFamily = '-apple-system,system-ui,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif';
    Chart.defaults.global.defaultFontColor = '#292b2c'; {% endcomment %}
    // Pie Chart Example
    var ctx = document.getElementById("myPieChart");
    var myPieChart = new Chart(ctx, {
    type: 'pie',
    data: {
        labels: ["Κάτω", "Ακριβώς", "Πάνω"],
        datasets: [{
        data: [{{shops_below}}, {{shops_equal}}, {{shops_above}}],
        backgroundColor: ['#dc3545', '#28a745', '#007bff'],
        }],
    },
    });

 //top table
 var $shops_table = $('#shops-table');

 $(function() {
     $('#shops-table_print-dropdown').find('.dropdown-item').on('click', function (e) {
         e.preventDefault();
         selector_btn = document.getElementById('print-selector');
         selector_btn.innerText = e.target.innerText; 
         data = {};
         if (e.target.attributes['area-value'].value == 'selected'){
             data = {
                 field: 'state',
                 checkbox: true,
                 visible: $(this).attr('area-value') === 'selected'
             };
         }
         $shops_table.bootstrapTable('destroy').bootstrapTable({
             exportDataType: $(this).attr('area-value'),
             exportTypes: ['csv', 'txt', 'excel', 'pdf'],
             columns: [
                 data,
             ],
             docDefinition:{
                pageOrientation:'portrait',
             },
         })
         }).trigger('change')
        });

        $(window).on('load', ()=>{
            export_btn_group = $('.export.btn-group');
            exoport_dropdown = export_btn_group.find("[aria-label='Export']");
            exoport_dropdown.parent().css("cursor", "not-allowed");
            exoport_dropdown.each( (index, elements) => {
                $(elements).attr("disabled", "true");
            });
        });
</script>
{% endblock %}